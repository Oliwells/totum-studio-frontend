<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Totum Studio — Super Simple Social Poster</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --border:#1f2937; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; background:rgba(15,23,42,0.8); backdrop-filter: blur(8px); border-bottom:1px solid var(--border); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 22px; margin: 0; }
    .bar { display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap: wrap; }
    input, select, textarea { background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; width:100%; }
    textarea { min-height: 160px; resize: vertical; }
    button { border:0; border-radius: 12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn { background:#1f2937; color:var(--text); border:1px solid var(--border); }
    .btn.primary { background:var(--accent); color:#051b0e; }
    .btn.danger { background:var(--danger); color:white; }
    .grid { display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 840px){ .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; }
    .muted { color: var(--muted); font-size: 13px; }
    .row { display:flex; gap:10px; align-items:center; }
    .space { height: 16px; }
    .pill { font-size:12px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); }
    .post-text { white-space: pre-wrap; line-height: 1.5; }
    .label { font-size:13px; color:var(--muted); margin-bottom:6px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Totum Studio</h1>
      <div class="bar">
        <div class="row" style="gap:6px">
          <span class="pill" id="status">API: …</span>
        </div>
        <select id="brandSelect" style="max-width:280px"></select>
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn primary" id="gen2">Generate 2 drafts</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top: 10px">
    <div class="card" style="margin-bottom:14px">
      <div class="row" style="justify-content: space-between; align-items: baseline;">
        <div>
          <div class="label">Filters</div>
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <button class="btn" data-filter="">All</button>
            <button class="btn" data-filter="draft">Draft</button>
            <button class="btn" data-filter="approved">Approved</button>
            <button class="btn" data-filter="published">Published</button>
          </div>
        </div>
        <div class="muted" id="brandInfo"></div>
      </div>
    </div>

    <div class="grid" id="posts"></div>
  </main>

  <template id="postCardTmpl">
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items:center; margin-bottom:8px">
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <span class="pill status"></span>
          <span class="pill">LinkedIn</span>
          <span class="pill createdAt"></span>
        </div>
      </div>
      <div class="post-text text"></div>
      <div class="space"></div>
      <div class="label">Edit</div>
      <textarea class="editor"></textarea>
      <div class="space"></div>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <input class="schedule" type="datetime-local" />
        <button class="btn" data-act="save">Save</button>
        <button class="btn primary" data-act="approve">Approve</button>
        <button class="btn" data-act="preview">Preview</button>
      </div>
      <div class="space"></div>
      <div class="muted" style="font-size:12px">ID: <span class="id"></span></div>
    </div>
  </template>

  <script>
    // ====== CONFIG ======
    // Replace with your Render backend URL or subdomain once set up
    const API_BASE = 'https://super-simple-social.onrender.com';

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const state = {
      brands: [],
      brandId: null,
      posts: [],
      filter: ''
    };

    async function ping(){
      try{
        const r = await fetch(API_BASE + '/');
        if(!r.ok) throw new Error('API not ok');
        $('#status').textContent = 'API: Online';
        $('#status').style.color = '#22c55e';
      }catch(e){
        $('#status').textContent = 'API: Offline';
        $('#status').style.color = '#ef4444';
      }
    }

    async function loadBrands(){
      const r = await fetch(API_BASE + '/brands');
      state.brands = await r.json();
      const sel = $('#brandSelect');
      sel.innerHTML = '';
      state.brands.forEach(b=>{
        const o = document.createElement('option');
        o.value = b.id; o.textContent = b.name; sel.appendChild(o);
      })
      if(!state.brandId && state.brands[0]) state.brandId = state.brands[0].id;
      sel.value = state.brandId || '';
      renderBrandInfo();
    }

    function renderBrandInfo(){
      const b = state.brands.find(x=>x.id===state.brandId);
      if(!b){ $('#brandInfo').textContent = ''; return }
      const days = (b.cadence?.weekdays||[]).map(d=>['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][d-1]).join(', ');
      $('#brandInfo').textContent = `${b.name} • ${days || '—'} @ ${String(b.cadence?.hour||10).padStart(2,'0')}:${String(b.cadence?.minute||0).padStart(2,'0')}`;
    }

    async function loadPosts(){
      if(!state.brandId) return;
      const qs = new URLSearchParams({ brand: state.brandId });
      if(state.filter) qs.set('status', state.filter);
      const r = await fetch(API_BASE + '/posts?' + qs.toString());
      state.posts = await r.json();
      renderPosts();
    }

    function renderPosts(){
      const grid = $('#posts');
      grid.innerHTML = '';
      const tmpl = $('#postCardTmpl');
      state.posts.forEach(p=>{
        const node = tmpl.content.cloneNode(true);
        node.querySelector('.status').textContent = p.status;
        node.querySelector('.createdAt').textContent = new Date(p.createdAt||Date.now()).toLocaleString();
        node.querySelector('.text').textContent = p.text;
        node.querySelector('.editor').value = p.text;
        node.querySelector('.id').textContent = p.id;
        const dt = node.querySelector('.schedule');
        if(p.scheduledAt){
          const t = new Date(p.scheduledAt);
          const tzOff = t.getTimezoneOffset();
          const localISO = new Date(t.getTime() - tzOff*60000).toISOString().slice(0,16);
          dt.value = localISO;
        }
        node.querySelector('[data-act="save"]').onclick = async ()=>{
          const text = node.querySelector('.editor').value;
          const scheduledAt = dt.value ? new Date(dt.value).toISOString() : null;
          await fetch(API_BASE + '/posts/' + p.id, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, scheduledAt }) });
          await loadPosts();
        };
        node.querySelector('[data-act="approve"]').onclick = async ()=>{
          await fetch(API_BASE + '/posts/' + p.id + '/approve', { method:'POST' });
          await loadPosts();
        };
        node.querySelector('[data-act="preview"]').onclick = ()=>{
          const preview = window.open('', '_blank');
          preview.document.write(`<!doctype html><title>Preview</title><body style="font-family:system-ui;padding:24px;line-height:1.5"><h3 style="margin-top:0">LinkedIn Preview</h3><div style="border:1px solid #ddd;border-radius:12px;padding:16px;max-width:680px;white-space:pre-wrap">${escapeHtml(node.querySelector('.editor').value)}</div></body>`);
        };
        grid.appendChild(node);
      })
    }

    function escapeHtml(str){
      return (str||'').replace(/[&<>"]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[s]));
    }

    async function generate(count=2){
      if(!state.brandId) return alert('No brand selected');
      await fetch(API_BASE + '/brands/' + state.brandId + '/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ count }) });
      await loadPosts();
    }

    // ====== Events ======
    $('#refresh').onclick = loadPosts;
    $('#gen2').onclick = ()=>generate(2);
    $('#brandSelect').onchange = (e)=>{ state.brandId = e.target.value; renderBrandInfo(); loadPosts(); };
    $$('.card .btn[data-filter], [data-filter]').forEach(btn=>{
      btn.onclick = (e)=>{ state.filter = e.target.getAttribute('data-filter')||''; loadPosts(); };
    });

    // ====== Init ======
    (async function(){
      await ping();
      await loadBrands();
      await loadPosts();
    })();
  </script>
</body>
</html>
